(function(){"use strict";function e([e,...t],...n){return n.reduce((e,n)=>e.concat(n,t.shift()),[e]).filter((e)=>null!=e).join("")}function n(...e){return Object.assign({},...e)}function r(e){return"#"===e.charAt(0)&&(e=e.substr(1)),3===e.length&&(e=e.split("").map((e)=>e+e).join("")),e.match(/.{1,2}/g).map((e)=>parseFloat((parseInt(e,16)/255).toFixed(2)))}function a(e){return e.reduce((e,t)=>{let n=(~~(255*t)).toString(16);return 1===n.length&&(n="0"+n),e+n},"#")}function o(e,t,n){let a,r,o;if(0==t)a=r=o=n;else{function i(e,n,r){return 0>r&&(r+=1),1<r&&(r-=1),r<1/6?e+6*(n-e)*r:r<1/2?n:r<2/3?e+6*((n-e)*(2/3-r)):e}let s=0.5>n?n*(1+t):n+t-n*t,c=2*n-s;a=i(c,s,e+1/3),r=i(c,s,e),o=i(c,s,e-1/3)}return[a,r,o]}function i(){let e=new Fe(3);return e[0]=0,e[1]=0,e[2]=0,e}function s(e,t,n){let r=new Fe(3);return r[0]=e,r[1]=t,r[2]=n,r}function c(e,t,n){return e[0]=t[0]+n[0],e[1]=t[1]+n[1],e[2]=t[2]+n[2],e}function m(e,t,n){return e[0]=t[0]-n[0],e[1]=t[1]-n[1],e[2]=t[2]-n[2],e}function _(e,t,n){return e[0]=t[0]*n,e[1]=t[1]*n,e[2]=t[2]*n,e}function d(e,t){let n=t[0]-e[0],r=t[1]-e[1],a=t[2]-e[2];return xe(n*n+r*r+a*a)}function p(e,t){let n=t[0],r=t[1],a=t[2],o=n*n+r*r+a*a;return 0<o&&(o=1/xe(o),e[0]=t[0]*o,e[1]=t[1]*o,e[2]=t[2]*o),e}function l(e,t){return e[0]*t[0]+e[1]*t[1]+e[2]*t[2]}function f(e,t,n){let r=t[0],a=t[1],o=t[2],i=n[0],s=n[1],c=n[2];return e[0]=a*c-o*s,e[1]=o*i-r*c,e[2]=r*s-a*i,e}function u(e,n,r,a){let t=n[0],o=n[1],i=n[2];return e[0]=t+a*(r[0]-t),e[1]=o+a*(r[1]-o),e[2]=i+a*(r[2]-i),e}function g(e,t,n){let r=t[0],a=t[1],o=t[2],i=n[3]*r+n[7]*a+n[11]*o+n[15];return i=i||1,e[0]=(n[0]*r+n[4]*a+n[8]*o+n[12])/i,e[1]=(n[1]*r+n[5]*a+n[9]*o+n[13])/i,e[2]=(n[2]*r+n[6]*a+n[10]*o+n[14])/i,e}function h(){let e=new Fe(16);return e[0]=1,e[1]=0,e[2]=0,e[3]=0,e[4]=0,e[5]=1,e[6]=0,e[7]=0,e[8]=0,e[9]=0,e[10]=1,e[11]=0,e[12]=0,e[13]=0,e[14]=0,e[15]=1,e}function E(e,t){let n=t[0],r=t[1],a=t[2],o=t[3],i=t[4],s=t[5],c=t[6],m=t[7],d=t[8],_=t[9],l=t[10],f=t[11],u=t[12],p=t[13],g=t[14],h=t[15],E=n*s-r*i,A=n*c-a*i,v=n*m-o*i,y=r*c-a*s,b=r*m-o*s,k=a*m-o*c,x=d*p-_*u,T=d*g-l*u,L=d*h-f*u,S=_*g-l*p,R=_*h-f*p,F=l*h-f*g,P=E*F-A*R+v*S+y*L-b*T+k*x;return P?(P=1/P,e[0]=(s*F-c*R+m*S)*P,e[1]=(a*R-r*F-o*S)*P,e[2]=(p*k-g*b+h*y)*P,e[3]=(l*b-_*k-f*y)*P,e[4]=(c*L-i*F-m*T)*P,e[5]=(n*F-a*L+o*T)*P,e[6]=(g*v-u*k-h*A)*P,e[7]=(d*k-l*v+f*A)*P,e[8]=(i*R-s*L+m*x)*P,e[9]=(r*L-n*R-o*x)*P,e[10]=(u*b-p*v+h*E)*P,e[11]=(_*v-d*b-f*E)*P,e[12]=(s*T-i*S-c*x)*P,e[13]=(n*S-r*T+a*x)*P,e[14]=(p*A-u*y-g*E)*P,e[15]=(d*y-_*A+l*E)*P,e):null}function A(e,t,n){let r=t[0],a=t[1],o=t[2],i=t[3],s=t[4],c=t[5],m=t[6],d=t[7],_=t[8],l=t[9],f=t[10],u=t[11],p=t[12],g=t[13],h=t[14],E=t[15],A=n[0],v=n[1],y=n[2],b=n[3];return e[0]=A*r+v*s+y*_+b*p,e[1]=A*a+v*c+y*l+b*g,e[2]=A*o+v*m+y*f+b*h,e[3]=A*i+v*d+y*u+b*E,A=n[4],v=n[5],y=n[6],b=n[7],e[4]=A*r+v*s+y*_+b*p,e[5]=A*a+v*c+y*l+b*g,e[6]=A*o+v*m+y*f+b*h,e[7]=A*i+v*d+y*u+b*E,A=n[8],v=n[9],y=n[10],b=n[11],e[8]=A*r+v*s+y*_+b*p,e[9]=A*a+v*c+y*l+b*g,e[10]=A*o+v*m+y*f+b*h,e[11]=A*i+v*d+y*u+b*E,A=n[12],v=n[13],y=n[14],b=n[15],e[12]=A*r+v*s+y*_+b*p,e[13]=A*a+v*c+y*l+b*g,e[14]=A*o+v*m+y*f+b*h,e[15]=A*i+v*d+y*u+b*E,e}function v(e,t,n,r){let a=t[0],o=t[1],i=t[2],s=t[3],c=a+a,m=o+o,d=i+i,_=a*c,l=a*m,f=a*d,u=o*m,p=o*d,g=i*d,h=s*c,E=s*m,A=s*d,v=r[0],y=r[1],b=r[2];return e[0]=(1-(u+g))*v,e[1]=(l+A)*v,e[2]=(f-E)*v,e[3]=0,e[4]=(l-A)*y,e[5]=(1-(_+g))*y,e[6]=(p+h)*y,e[7]=0,e[8]=(f+E)*b,e[9]=(p-h)*b,e[10]=(1-(_+u))*b,e[11]=0,e[12]=n[0],e[13]=n[1],e[14]=n[2],e[15]=1,e}function y(e,t,n,r,a){let o=1/Math.tan(t/2),i=1/(r-a);return e[0]=o/n,e[1]=0,e[2]=0,e[3]=0,e[4]=0,e[5]=o,e[6]=0,e[7]=0,e[8]=0,e[9]=0,e[10]=(a+r)*i,e[11]=-1,e[12]=0,e[13]=0,e[14]=2*a*r*i,e[15]=0,e}function b(e,t,n,r){let a,o,i,s,c,m,d,_,l,f,u=t[0],p=t[1],g=t[2],h=r[0],E=r[1],A=r[2],v=n[0],y=n[1],b=n[2];return be(u-v)<Re&&be(p-y)<Re&&be(g-b)<Re?mat4.identity(e):(d=u-v,_=p-y,l=g-b,f=1/xe(d*d+_*_+l*l),d*=f,_*=f,l*=f,a=E*l-A*_,o=A*d-h*l,i=h*_-E*d,f=xe(a*a+o*o+i*i),f?(f=1/f,a*=f,o*=f,i*=f):(a=0,o=0,i=0),s=_*i-l*o,c=l*a-d*i,m=d*o-_*a,f=xe(s*s+c*c+m*m),f?(f=1/f,s*=f,c*=f,m*=f):(s=0,c=0,m=0),e[0]=a,e[1]=s,e[2]=d,e[3]=0,e[4]=o,e[5]=c,e[6]=_,e[7]=0,e[8]=i,e[9]=m,e[10]=l,e[11]=0,e[12]=-(a*u+o*p+i*g),e[13]=-(s*u+c*p+m*g),e[14]=-(d*u+_*p+l*g),e[15]=1,e)}function k(){let e=new Fe(9);return e[0]=1,e[1]=0,e[2]=0,e[3]=0,e[4]=1,e[5]=0,e[6]=0,e[7]=0,e[8]=1,e}function x(){let e=new Fe(4);return e[0]=0,e[1]=0,e[2]=0,e[3]=0,e}function T(){let e=new Fe(4);return e[0]=0,e[1]=0,e[2]=0,e[3]=1,e}function L(e,t,n){n*=0.5;let r=ye(n);return e[0]=r*t[0],e[1]=r*t[1],e[2]=r*t[2],e[3]=ve(n),e}function S(e,t,n){let r=t[0],a=t[1],o=t[2],i=t[3],s=n[0],c=n[1],m=n[2],d=n[3];return e[0]=r*d+i*s+a*m-o*c,e[1]=a*d+i*c+o*s-r*m,e[2]=o*d+i*m+r*c-a*s,e[3]=i*d-r*s-a*c-o*m,e}function R(e,n,r,a){let t,o,i,s,c,m=n[0],d=n[1],_=n[2],l=n[3],f=r[0],u=r[1],p=r[2],g=r[3];return o=m*f+d*u+_*p+l*g,0>o&&(o=-o,f=-f,u=-u,p=-p,g=-g),1e-6<1-o?(t=Math.acos(o),i=ye(t),s=ye((1-a)*t)/i,c=ye(a*t)/i):(s=1-a,c=a),e[0]=s*m+c*f,e[1]=s*d+c*u,e[2]=s*_+c*p,e[3]=s*l+c*g,e}function F(e,t){let n,r=t[0]+t[4]+t[8];if(0<r)n=xe(r+1),e[3]=0.5*n,n=0.5/n,e[0]=(t[5]-t[7])*n,e[1]=(t[6]-t[2])*n,e[2]=(t[1]-t[3])*n;else{let r=0;t[4]>t[0]&&(r=1),t[8]>t[3*r+r]&&(r=2);let a=(r+1)%3,o=(r+2)%3;n=xe(t[3*r+r]-t[3*a+a]-t[3*o+o]+1),e[r]=0.5*n,n=0.5/n,e[3]=(t[3*a+o]-t[3*o+a])*n,e[a]=(t[3*a+r]+t[3*r+a])*n,e[o]=(t[3*o+r]+t[3*r+o])*n}return e}function P(e,t,n,r){const a=Float32Array.of(...t,...n,...r);return Ue(e,F(e,a))}function I(e){return e*Ae/180}function N(e){const t=je.createBuffer();return je.bindBuffer(je.ARRAY_BUFFER,t),je.bufferData(je.ARRAY_BUFFER,new Float32Array(e),je.STATIC_DRAW),t}function w(e){const t=je.createBuffer();return je.bindBuffer(je.ELEMENT_ARRAY_BUFFER,t),je.bufferData(je.ELEMENT_ARRAY_BUFFER,new Uint16Array(e),je.STATIC_DRAW),t}function O(e,t){const n=je.createShader(e);if(je.shaderSource(n,t),je.compileShader(n),!je.getShaderParameter(n,je.COMPILE_STATUS))throw je.getShaderInfoLog(n);return n}function B(e,t){const n=je.createProgram();if(je.attachShader(n,e),je.attachShader(n,t),je.linkProgram(n),!je.getProgramParameter(n,je.LINK_STATUS))throw je.getProgramInfoLog(n);return n}function D(e){Tt=e}function C(e=0,t=1){return Ee(Lt()*(t-e+1)+e)}function U(e=0,t=1){return Lt()*(t-e)+e}function q(e){return e[C(0,e.length-1)]}function M([e,t],n,r=1.5){const a=U(0,2*Ae),o=U(0,n);return Ce(e+o*ve(a),r,t+o*ye(a))}function Y(e){const t=U(-Ae/10,Ae/10),n=U(0,Ae/10),r=Ce(ve(n)*ye(t),ye(n),ve(n)*ve(t));return p(r,r),g(r,r,e)}function H(e,t){return e.reduce((e,n,r)=>e+n*t[r],0)}function j(e){return xe(H(e,e))}function G(e,t){const n=V.slice();return m(n,e,t),j(n)}function W(e){return xe(he(1-e,2))}function K(e,t,n){const r=G(e,t),a=xe(n*n)/2;return Math.max(0,1-r/a)}function X(e,t){return be(H(e,t))}function Q(e,t,n){const a=t.get_component(Je),o=t.get_component(Rt),i=K(e.position,a.position,n),s=X(e.rotation,a.rotation),c=X(a.rotation,o.rotation),m=s*(1-W(i))+c*W(i);return(i+m)/2/2}function J(e,t,n){const a=t.get_component(Je),o=K(e.position,a.position,n),i=X(e.rotation,a.rotation);return(o*ye(i)+i*ye(o))/(0.8414709848078965*2)}function z(e=0,t=1){return Ee(Math.random()*(t-e+1)+e)}function Z(e){return e[z(0,e.length-1)]}function $(e,t){const n=It.sampleRate*e,r=It.createBuffer(2,n,It.sampleRate),a=r.getChannelData(0),o=r.getChannelData(1);for(let r=0;r<n;r++)a[r]=(2*Math.random()-1)*he(1-r/n,t),o[r]=(2*Math.random()-1)*he(1-r/n,t);return r}function ee(e){const t=It.createOscillator();t.type="sine",t.frequency.value=e;const n=It.createGain();n.gain.setTargetAtTime(1,It.currentTime,.1),n.gain.setTargetAtTime(0,It.currentTime+1,.1),t.connect(n),n.connect(wt),t.start(),t.stop(It.currentTime+10)}function te(){const e=Z(Nt);ee(e),setTimeout(te,2e3+z(0,1e4))}function ne(e,t,n,r){this.modulator_gain=e.createGain(),this.modulator_gain.gain.value=r||300,n.connect(this.modulator_gain),this.modulator_gain.connect(t.frequency),this.connect=(e)=>{t.disconnect(),t.connect(e)},this.disconnect=(e)=>{t.disconnect(e)}}function re(e,t,n){var r=e.createGain();r.gain.value=1,t.connect(r),n.connect(r.gain),this.connect=function(e){r.disconnect(),r.connect(e)}}function ae(e,t,n,r,a,o){var i=6.90776;this.attack_time=n||0.9,this.decay_time=r||0.9,this.min=a||0,this.max=o||50,this.trigger=(n)=>{var r=n||e.currentTime;t.cancelScheduledValues(r),t.setValueAtTime(this.min,r),t.setTargetAtTime(this.max,r,this.attack_time/i),t.setTargetAtTime(this.min,r+this.attack_time+1/44100,this.decay_time/i)}}function oe(e,t){const n=7e3,r=300,a=0.9,o=3e3,i=It.createPanner();i.panningModel="equalpower",i.distanceModel="exponential",i.refDistance=0.3,i.setPosition(...e);const s=It.createOscillator(),c=It.createOscillator(),m=It.createOscillator(),d=It.createGain(),_=It.createGain(),l=It.createGain();c.connect(d),m.connect(_);const f=new ne(It,s,d),u=new re(It,f,_),p=new ae(It,l.gain),g=new ae(It,c.frequency),h=new ae(It,m.frequency),E=new ae(It,d.gain),A=new ae(It,_.gain);u.connect(l),l.connect(i),i.connect(It.destination),f.modulator_gain.gain.value=r+n*Bt.ifrq,s.frequency.value=r+n*Bt.ifrq,p.attack_time=a*Bt.atk,p.decay_time=a*Bt.dcy,g.max=o*Bt.fmod1,g.attack_time=a*Bt.atkf1,g.decay_time=a*Bt.dcyf1,h.max=o*Bt.fmod2,h.attack_time=a*Bt.atkf2,h.decay_time=a*Bt.dcyf2,E.max=Bt.amod1,E.attack_time=a*Bt.atka1,E.decay_time=a*Bt.dcya1,A.max=-Bt.amod2,A.attack_time=a*Bt.atka2,A.decay_time=a*Bt.dcya2,l.gain.value=0,s.start(0),c.start(0),m.start(0),p.trigger(t),g.trigger(t),h.trigger(t),E.trigger(t),A.trigger(t)}function ie(e){for(let t=0;3>t;t++)setTimeout(()=>{oe(e,It.currentTime+0.4*Math.random())},1.2*(1e3*Bt.atk)*t)}function se(e,t,n,r,a){ie(e);for(let o=0;o<r;o++)setTimeout(()=>{const r=M([e[0],e[2]],n,100),o=new We({components:[new Je({position:e,scale:[0.2,0.2,0.2]}),new Ze({material:bt,color:t}),new rt({frame_time:16})]});o.get_component(rt).frames=Ct,o.get_component(Je).look_at(r),o.get_component(Je).rotate_ud(Ae/2),o.get_component(Je).rotate_rl(Math.PI),o.get_component(rt).create_buffers(),a.add(o),new Pt({object:o.get_component(Je),property:"position",to:r,time:1e3*Dt,game:a}).start().then(()=>{a.remove(o)})},15*o)}function ce(e,t){const n=o(e,Ut,t);return a(n)}function me(e){D(he(xt/e,2)),jt=[],Gt=[];const t=new it({width:window.innerWidth,height:window.innerHeight,clear_color:"#eeeeee",far:Vt});t.camera.add_component(new tt({keyboard_controlled:!1,mouse_controlled:!1,move_speed:25,rotate_speed:.5}));const n=U(0,1),r=ce(n,qt),a=new gt;a.get_component(Je).scale=[Vt,1,Vt],a.get_component(Ze).set({material:bt,color:r}),t.add(a);for(let n=0;n<he(e,2)+1;n++)St(n,r,C(0,2)).forEach((e)=>{jt.push(e),t.add(e)});t.camera.get_component(Je).position=M([0,0],Vt/3),t.camera.get_component(Je).look_at(q(jt).get_component(Je).position),t.camera.get_component(Je).look_at(Y(t.camera.get_component(Je).matrix)),delete t.camera.get_component(tt).dir_desc[69],delete t.camera.get_component(tt).dir_desc[81];const o=C(2,4);for(let t=0;t<o;t++){const e=M([0,0],Vt/3,-3);Gt.push(e)}return t.on("afterrender",function e(){t.off("afterrender",e);const n={snapshot:t.canvas.toDataURL(),position:t.camera.get_component(Je).position,rotation:t.camera.get_component(Je).rotation};window.dispatch(Le.SAVE_SNAPSHOT,n),t.stop()}),[t,n]}function de(e,t,n){e.camera.get_component(Je).set({position:[0,Mt,0],rotation:T()}),e.camera.get_component(tt).keyboard_controlled=!0,e.camera.get_component(tt).mouse_controlled=!0,e.camera.add_component(new Rt({target:n}));for(const r of e.entities)r.get_component(Ze).color="#000000";e.start(),e.on("tick",()=>{for(let r=0;r<Gt.length;r++)if(d(Gt[r],e.camera.get_component(Je).position)<Yt){se(Gt[r],ce(t,qt*Q(n,e.camera,Vt)),Vt/5,Ht,e),Gt.splice(r,1);break}}),e.on("afterrender",function(){const r=Q(n,e.camera,Vt);for(const n of e.entities)n.get_component(Ze).color=ce(t,qt*r)})}function _e(e,t){e.stop();const n=J(t,e.camera,Vt);return Ee(100*n)}function le(e){Xt[e.type]=performance.now()}function fe(){pe();for(const e of["mousemove","keydown"])if(Xt[e]+Wt<performance.now()){window.dispatch(Le.WARN_IDLE,e);break}}function ue(){window.addEventListener("mousemove",le),window.addEventListener("keydown",le),Kt=setTimeout(fe,5e3);const e=performance.now();Xt={mousemove:e,keydown:e}}function pe(){window.removeEventListener("mousemove",le),window.removeEventListener("keydown",le),clearTimeout(Kt)}function ge(t,n){return e`
     <div class="box action"
       onclick="goto(${Te.FIND}, ${n})"
       style="padding: .5rem; color: #666;">
       ${t}</div>
  `}var he=Math.pow,Ee=Math.floor,Ae=Math.PI,ve=Math.cos,ye=Math.sin,be=Math.abs,ke=Math.min,xe=Math.sqrt;const Te={TITLE:0,INTRO:1,FIND:2,PLAY:3,SCORE:4,LEVELS:5,NOPASS:6},Le={INIT:10,SAVE_SNAPSHOT:11,WARN_IDLE:12,VALIDATE_SNAPSHOT:13,LOCK_POINTER:14},Se={current_scene:Te.TITLE,next_scene:Te.TITLE},Re=1e-6;let Fe="undefined"==typeof Float32Array?Array:Float32Array;const Pe=function(e){let t=e[0],n=e[1],r=e[2];return xe(t*t+n*n+r*r)},Ie=function(){let e=i();return function(t,n,r,a,o,s){let c,i;for(n||(n=3),r||(r=0),i=a?ke(a*n+r,t.length):t.length,c=r;c<i;c+=n)e[0]=t[c],e[1]=t[c+1],e[2]=t[c+2],o(e,e,s),t[c]=e[0],t[c+1]=e[1],t[c+2]=e[2];return t}}(),Ne=Float32Array,V=Ne.of(0,0,0),we=Ne.of(1,1,1),Oe=Ne.of(1,0,0),Be=Ne.of(0,1,0),De=Ne.of(0,0,1),Ce=(...e)=>Ne.of(...e),Ve=function(){let e=x();return function(t,n,r,a,o,s){let c,i;for(n||(n=4),r||(r=0),i=a?ke(a*n+r,t.length):t.length,c=r;c<i;c+=n)e[0]=t[c],e[1]=t[c+1],e[2]=t[c+2],e[3]=t[c+3],o(e,e,s),t[c]=e[0],t[c+1]=e[1],t[c+2]=e[2],t[c+3]=e[3];return t}}(),Ue=function(e,t){let n=t[0],r=t[1],a=t[2],o=t[3],i=n*n+r*r+a*a+o*o;return 0<i&&(i=1/xe(i),e[0]=n*i,e[1]=r*i,e[2]=a*i,e[3]=o*i),e},qe=function(){let e=i(),t=s(1,0,0),n=s(0,1,0);return function(r,o,a){let i=l(o,a);return-0.999999>i?(f(e,t,o),1e-6>Pe(e)&&f(e,n,o),p(e,e),L(r,e,Math.PI),r):0.999999<i?(r[0]=0,r[1]=0,r[2]=0,r[3]=1,r):(f(e,o,a),r[0]=e[0],r[1]=e[1],r[2]=e[2],r[3]=1+i,Ue(r,r))}}(),Me=function(){let e=T(),n=T();return function(r,o,a,i,s,c){return R(e,o,s,c),R(n,a,i,c),R(r,e,n,2*c*(1-c)),r}}(),Ye=function(){let e=k();return function(t,n,r,a){return e[0]=r[0],e[3]=r[1],e[6]=r[2],e[1]=a[0],e[4]=a[1],e[7]=a[2],e[2]=-n[0],e[5]=-n[1],e[8]=-n[2],Ue(t,F(t,e))}}(),He=document.createElement("canvas"),je=He.getContext("webgl"),Ge={components:[],skip:!1};class We{constructor(e={}){Object.assign(this,Ge,e),this.entities=new Set,this.components=new Map,this.add_components(e.components)}add_component(e){e.entity=this,e.mount(),this.components.set(e.constructor,e)}add_components(e=[]){e.forEach((e)=>this.add_component(e))}get_component(e){return this.components.get(e)}get_components(...e){return e.map((e)=>this.get_component(e))}add(e){e.parent=this,this.entities.add(e)}update(e){if(!this.skip){const t=(t)=>t.update(e);this.components.forEach(t),this.entities.forEach(t)}}render(e){if(!this.skip){const t=(t)=>t.render(e);this.components.forEach(t),this.entities.forEach(t)}}}const Ke={entity:null};class Xe{constructor(e){Object.assign(this,Ke,e)}mount(){}set(e){Object.assign(this,e)}update(){}render(){}}const Qe={_scale:we.slice(),_rotation:T(),scale:we.slice(),position:V.slice(),rotation:T()};class Je extends Xe{constructor(e){super(Object.assign({matrix:h(),world_matrix:h(),world_to_self:h()},Qe,e))}get up(){const e=this.matrix.slice(4,7);return p(e,e)}get forward(){const e=this.matrix.slice(8,11);return p(e,e)}set position(e){v(this.matrix,this.rotation,e,this.scale)}get position(){return this.matrix.slice(12,15)}set scale(e){this._scale=e,v(this.matrix,this.rotation,this.position,e)}get scale(){return this._scale}set rotation(e){this._rotation=e,v(this.matrix,e,this.position,this.scale)}get rotation(){return this._rotation}look_at(e){const t=V.slice();m(t,e,this.position),p(t,t);const n=Ce(t[2],0,-t[0]);p(n,n);const r=V.slice();f(r,t,n);const a=T();P(a,n,r,t),this.rotation=a}rotate_along(e,t){const n=T();L(n,e,t),S(n,this.rotation,n),this.rotation=n}rotate_rl(e){this.rotate_along(Be,e)}rotate_ud(e){this.rotate_along(Oe,e)}translate(e){const t=V.slice();c(t,this.position,e),this.position=t}get_view_matrix(e){const t=[];return c(t,this.position,this.forward),b(e,this.position,t,this.up),e}update(){this.entity.parent?A(this.world_matrix,this.entity.parent.get_component(Je).world_matrix,this.matrix):this.world_matrix=this.matrix.slice(),E(this.world_to_self,this.world_matrix)}}const ze={material:null,vertices:[],indices:[],normals:[],color:"fff",color_opacity:1};class Ze extends Xe{constructor(e){super(e),Object.assign(this,ze,e),this.create_buffers()}set color(e){this._color=e||"fff",this.color_vec=[...r(this._color),this.color_opacity]}get color(){return this._color}create_buffers(){this.buffers={vertices:N(this.vertices),indices:w(this.indices),qty:this.indices.length,normals:N(this.normals)}}render(){this.material.render(this.entity)}}const $e=3,et={keyboard_controlled:!1,mouse_controlled:!1,move_speed:3.5,rotate_speed:.5,dir_desc:{37:"yl",38:"pu",39:"yr",40:"pd",65:"l",68:"r",69:"u",81:"d",83:"b",87:"f"}};class tt extends Xe{constructor(e){super(e),Object.assign(this,et,e)}handle_keys(e,{f:t=0,b:n=0,l:a=0,r:o=0,u:r=0,d:i=0,pu:s=0,pd:c=0,yl:d=0,yr:l=0}){const f=this.entity.get_component(Je),u=e/1e3*this.move_speed,h=Ce(a-o,0,t-n);g(h,h,f.matrix),m(h,h,f.position),h[1]=r-i,p(h,h),_(h,h,u),f.translate(h);this.handle_mouse(e,{x:d*$e-l*$e,y:s*$e-c*$e})}handle_mouse(e,{x:t,y:n}){const r=this.entity.get_component(Je);if(0!==t||0!==n){const a=e/1e3,o=this.rotate_speed*a*t,i=this.rotate_speed*a*n,s=Ce(ve(i)*ye(o),ye(i),ve(i)*ve(o));p(s,s),g(s,s,r.matrix),r.look_at(s)}}update(e){if(this.keyboard_controlled&&this.entity.game){const t={};for(const[e,n]of Object.entries(this.dir_desc))t[n]=this.entity.game.get_key(e);this.handle_keys(e,t)}this.mouse_controlled&&this.entity.game&&this.handle_mouse(e,this.entity.game.mouse_delta)}}const nt={buffers:[],current_frame:0,next_frame:1,current_tick:0,frame_time:16};class rt extends Xe{constructor(e){super(e),Object.assign(this,nt,e),this.frames&&this.frames.length&&this.create_buffers()}create_buffers(){this.number_of_frames=this.frames.length,this.entity.get_component(Ze).buffers=this.frames.map((e)=>({vertices:N(e.vertices),indices:w(e.indices),qty:e.indices.length,normals:N(e.normals)}))}get_next_frame(){let e=this.current_frame;return e++,e%this.number_of_frames}update(){this.current_tick++,this.frame_delta=1-this.current_tick%this.frame_time/this.frame_time,this.current_tick%this.frame_time||(this.current_frame=this.next_frame,this.next_frame=this.get_next_frame())}}const at={canvas:He,width:800,height:600,dom:document.body,fps:60,running:!0,fov:60,near:0.35,far:85,clear_color:"#FFFFFF",light_position:V.slice(),light_intensity:0.6},ot=["keydown","keyup","mousemove"];class it{constructor(e){Object.assign(this,at,e),this.canvas.width=this.width,this.canvas.height=this.height,this.dom.appendChild(He),this.reset(),this.camera=new We({components:[new Je,new tt]}),this.camera.game=this,this.projMatrix=h(),this.viewMatrix=h(),y(this.projMatrix,I(this.fov),this.width/this.height,this.near,this.far),this.tick_delta=1e3/this.fps;for(const t of ot){const e="on"+t;this[e]=this[e].bind(this),window.addEventListener(t,this[e])}this.running&&this.start(),je.enable(je.CULL_FACE),je.enable(je.DEPTH_TEST),je.clear(je.DEPTH_BUFFER_BIT|je.COLOR_BUFFER_BIT)}get clear_color(){return this._clear_color}set clear_color(e){this._clear_color=e;const t=r(e);je.clearColor(t[0],t[1],t[2],1)}stop(){this.running=!1}start(){this.running=!0,this.last_tick=performance.now(),window.requestAnimationFrame((e)=>this.frame(e))}reset(){this.entities=new Set,this.listeners=new Map,this.keys={},this.mouse_delta={x:0,y:0}}destroy(){for(const e of ot)window.removeEventListener(e,this[e])}emit(e,...t){if(this.listeners.has(e))for(const n of this.listeners.get(e))n(...t)}on(e,t){this.listeners.has(e)||this.listeners.set(e,new Set),this.listeners.get(e).add(t)}off(e,t){this.listeners.has(e)&&this.listeners.get(e).delete(t)}onkeydown(t){this.keys[t.keyCode]=1}onkeyup(t){this.keys[t.keyCode]=0}get_key(e){return this.keys[e]||0}onmousemove(t){this.mouse_delta.x-=t.movementX,this.mouse_delta.y-=t.movementY}frame(e){if(this.running&&window.requestAnimationFrame((e)=>this.frame(e)),e>this.last_tick+this.tick_delta){const t=e-this.last_tick,n=Ee(t/this.tick_delta);this.perform_ticks(n),this.render()}}perform_ticks(e){this.mouse_delta.x/=e,this.mouse_delta.y/=e;for(let t=0;t<e;t++)this.last_tick+=this.tick_delta,this.update();this.mouse_delta.x=0,this.mouse_delta.y=0}update(){this.emit("tick",this.last_tick),this.entities.forEach((e)=>e.update(this.tick_delta)),this.camera.update(this.tick_delta),this.camera.get_component(Je).get_view_matrix(this.viewMatrix)}render(){je.clear(je.COLOR_BUFFER_BIT|je.DEPTH_BUFFER_BIT),je.viewport(0,0,this.canvas.width,this.canvas.height),this.entities.forEach((e)=>e.render()),this.emit("afterrender")}add(e){e.game=this,this.entities.add(e)}remove(e){this.entities.delete(e)}}class st{constructor(e){this.to=e.to,this.time=e.time||1e3,this.game=e.game,this.object=e.object,this.property=e.property,this.cb=e.cb}do_step(e){this.current_step=ke(1,(e-this.first_tick)/this.tick_delta*this.step),this.action()}action(){}pre_start(){this.tick_delta=this.game.tick_delta,this.first_tick=this.game.last_tick,this.number_of_ticks=Math.ceil(this.time/this.tick_delta),this.step=1/this.number_of_ticks}start(){return this.pre_start(),new Promise((e)=>{const t=(n)=>{1===this.current_step?(this.game.off("tick",t),e()):this.do_step(n,e)};this.game.on("tick",t)})}}class ct{constructor(){this.uniforms={},this.attribs={}}setup_program(){if(this.program=B(O(je.VERTEX_SHADER,this.get_shader_code(this.vertex_shader.variables,this.vertex_shader.body)),O(je.FRAGMENT_SHADER,this.get_shader_code(this.fragment_shader.variables,this.fragment_shader.body))),this.program.error)return void console.log(this.program.error)}get_uniforms_and_attrs(e,t){e.forEach((e)=>{this.uniforms[e]=je.getUniformLocation(this.program,e)}),t.forEach((e)=>{this.attribs[e]=je.getAttribLocation(this.program,e)})}get_shader_code(e,t){return`
      precision mediump float;
      ${e}

      void main()
      {
        ${t}
      }
    `}render(e){let t=e,n=t.game;for(;t.parent&&!n;)t=t.parent,n=t.game;const[r,a]=e.get_components(Je,Ze);je.useProgram(this.program),je.uniformMatrix4fv(this.uniforms.p,je.FALSE,n.projMatrix),je.uniformMatrix4fv(this.uniforms.v,je.FALSE,n.viewMatrix),je.uniformMatrix4fv(this.uniforms.w,je.FALSE,r.world_matrix),je.uniform4fv(this.uniforms.c,a.color_vec),this.apply_shader(e,n)}}const mt=[0.5,0.5,0.5,0.5,0.5,-0.5,0.5,-0.5,0.5,0.5,-0.5,-0.5,-0.5,0.5,-0.5,-0.5,0.5,0.5,-0.5,-0.5,-0.5,-0.5,-0.5,0.5,-0.5,0.5,-0.5,0.5,0.5,-0.5,-0.5,0.5,0.5,0.5,0.5,0.5,-0.5,-0.5,0.5,0.5,-0.5,0.5,-0.5,-0.5,-0.5,0.5,-0.5,-0.5,-0.5,0.5,0.5,0.5,0.5,0.5,-0.5,-0.5,0.5,0.5,-0.5,0.5,0.5,0.5,-0.5,-0.5,0.5,-0.5,0.5,-0.5,-0.5,-0.5,-0.5,-0.5],dt=[0,2,1,2,3,1,4,6,5,6,7,5,8,10,9,10,11,9,12,14,13,14,15,13,16,18,17,18,19,17,20,22,21,22,23,21],_t=[1,0,0,1,0,0,1,0,0,1,0,0,-1,0,0,-1,0,0,-1,0,0,-1,0,0,0,1,0,0,1,0,0,1,0,0,1,0,0,-1,0,0,-1,0,0,-1,0,0,-1,0,0,0,1,0,0,1,0,0,1,0,0,1,0,0,-1,0,0,-1,0,0,-1,0,0,-1];class lt extends We{constructor(e={}){e.components=[new Je,new Ze({vertices:mt,indices:dt,normals:_t,material:e.material})],super(e)}}const ft=[-1,0,1,1,0,1,1,0,-1,-1,0,-1],ut=[0,1,3,3,1,2],pt=[0,1,0,0,1,0,0,1,0,0,1,0];class gt extends We{constructor(e={}){e.components=[new Je,new Ze({vertices:ft,indices:ut,normals:pt,material:e.material})],super(e)}}const ht=0.5+2.23606797749979/2,Et=[-1,ht,0,1,ht,0,-1,-ht,0,1,-ht,0,0,-1,ht,0,1,ht,0,-1,-ht,0,1,-ht,ht,0,-1,ht,0,1,-ht,0,-1,-ht,0,1],At=[-1,ht,0,1,ht,0,-1,-ht,0,1,-ht,0,0,-1,ht,0,1,ht,0,-1,-ht,0,1,-ht,ht,0,-1,ht,0,1,-ht,0,-1,-ht,0,1],vt=[0,11,5,0,5,1,0,1,7,0,7,10,0,10,11,1,5,9,5,11,4,11,10,2,10,7,6,7,1,8,3,9,4,3,4,2,3,2,6,3,6,8,3,8,9,4,9,5,2,4,11,6,2,10,8,6,7,9,8,1];class yt extends We{constructor(e={}){e.components=[new Je,new Ze({vertices:Et,indices:vt,normals:At,material:e.material})],super(e)}}const bt=new class extends ct{constructor(){super(),this.vertex_shader={variables:`uniform mat4 p;
        uniform mat4 v;
        uniform mat4 w;
        uniform float frame_delta;
        uniform float do_morph;
        attribute vec3 P_current;
        attribute vec3 P_next;`,body:`if (do_morph == 1.0) {
        float next_frame_delta = 1.0 - frame_delta;
        gl_Position = p * v * vec4((w * vec4(P_next * next_frame_delta + P_current * frame_delta, 1.0)).xyz, 1.0);
      } else {
        gl_Position = p * v * vec4((w * vec4(P_current, 1.0)).xyz, 1.0);
      }`},this.fragment_shader={variables:"uniform vec4 c;",body:"gl_FragColor = c;"},this.setup_program(),this.get_uniforms_and_attrs(["p","v","w","c","frame_delta","do_morph"],["P_current","P_next"])}apply_shader(e){const[t,n]=e.get_components(Ze,rt);let r=t.buffers;n?(r=t.buffers[n.current_frame],je.bindBuffer(je.ARRAY_BUFFER,t.buffers[n.next_frame].vertices),je.vertexAttribPointer(this.attribs.P_next,3,je.FLOAT,je.FALSE,0,0),je.enableVertexAttribArray(this.attribs.P_next),je.uniform1f(this.uniforms.do_morph,1),je.uniform1f(this.uniforms.frame_delta,n.frame_delta)):je.uniform1f(this.uniforms.do_morph,0),je.bindBuffer(je.ARRAY_BUFFER,r.vertices),je.vertexAttribPointer(this.attribs.P_current,3,je.FLOAT,je.FALSE,0,0),je.enableVertexAttribArray(this.attribs.P_current),je.bindBuffer(je.ELEMENT_ARRAY_BUFFER,r.indices),je.drawElements(je.TRIANGLES,r.qty,je.UNSIGNED_SHORT,0)}};const kt=new class extends ct{constructor(){super(),this.vertex_shader={variables:`  uniform mat4 p;
        uniform mat4 v;
        uniform mat4 w;
        uniform float frame_delta;
        uniform float do_morph;
        attribute vec3 P_current;
        attribute vec3 P_next;
        attribute vec3 N_current;
        attribute vec3 N_next;
        varying vec3 fp;
        varying vec3 fn;`,body:`if (do_morph == 1.0) {
        float next_frame_delta = 1.0 - frame_delta;
        fp = (w * vec4(P_next * next_frame_delta + P_current * frame_delta, 1.0)).xyz;
        fn = (w * vec4(N_next * next_frame_delta + N_current * frame_delta, 0.0)).xyz;
      } else {
        fp = (w * vec4(P_current, 1.0)).xyz;
        fn = (w * vec4(N_current, 0.0)).xyz;
      }
      gl_Position = p * v * vec4(fp, 1.0);`},this.fragment_shader={variables:`uniform vec3 lp;
        uniform vec4 c;
        uniform vec2 li;
        varying vec3 fp;
        varying vec3 fn;`,body:`gl_FragColor = vec4(c.rgb * li.x + li.y * max(dot(fn, normalize(lp - fp)), 0.0), c.a);`},this.setup_program(),this.get_uniforms_and_attrs(["p","v","w","lp","li","c","do_morph","frame_delta"],["P_current","P_next","N_current","N_next"])}apply_shader(e,t){const[n,r]=e.get_components(Ze,rt);let a=n.buffers;r?(a=n.buffers[r.current_frame],je.bindBuffer(je.ARRAY_BUFFER,n.buffers[r.next_frame].vertices),je.vertexAttribPointer(this.attribs.P_next,3,je.FLOAT,je.FALSE,0,0),je.enableVertexAttribArray(this.attribs.P_next),je.uniform1f(this.uniforms.do_morph,1),je.uniform1f(this.uniforms.frame_delta,r.frame_delta)):je.uniform1f(this.uniforms.do_morph,0),je.bindBuffer(je.ARRAY_BUFFER,a.vertices),je.vertexAttribPointer(this.attribs.P_current,3,je.FLOAT,je.FALSE,0,0),je.enableVertexAttribArray(this.attribs.P_current),je.bindBuffer(je.ARRAY_BUFFER,a.normals),je.vertexAttribPointer(this.attribs.N_current,3,je.FLOAT,je.FALSE,0,0),je.enableVertexAttribArray(this.attribs.N_current),je.bindBuffer(je.ELEMENT_ARRAY_BUFFER,a.indices),je.drawElements(je.TRIANGLES,a.qty,je.UNSIGNED_SHORT,0),je.uniform3fv(this.uniforms.lp,t.light_position),je.uniform2fv(this.uniforms.li,[t.light_intensity,1-t.light_intensity])}},xt=132079672568928;let Tt=xt;const Lt=function(){return Tt=16807*Tt%2147483647,(Tt-1)/2147483646},St=(e,t,n)=>{let r=[];const a=ve(e*Ae),o=ve(e*Ae),i=75+100*ye(e*Ae/6);switch(n){case 0:case 1:for(let n=C(0,2);n--;){const n=C(5,80),s=C(5,80),c=new lt;c.get_component(Ze).set({material:bt,color:t}),c.get_component(Je).set({position:[a*i+s,n/2,20*o*e],scale:[s,n,C(5,80)]}),r.push(c)}break;case 2:const s=new yt,c=new lt,m=C(12,17);c.get_component(Je).set({position:[a*i,m/2,20*o*e],scale:[1,m,1]}),c.get_component(Ze).set({material:bt,color:t}),r.push(c);const d=C(2,7);s.get_component(Je).set({position:[a*i,m,20*o*e],scale:[d,d,d]}),s.get_component(Ze).set({material:bt,color:t}),r.push(s);break;case 3:const _=new lt;_.get_component(Ze).set({color:"#000000",material:bt}),_.get_component(Je).set({position:[0,1,0]}),r.push(_);}return r};class Rt extends Je{update(){this.position=this.entity.get_component(Je).position,this.look_at(this.target.position)}}const Ft=[2,1,0,6,3,0,6,0,9,2,0,3,2,1,0,6,3,0,6,0,9,2,0,3,19,1,2,19,1,2,2,16,19,2,16,19,2,3,16,2,3,16,16,3,6,16,6,17,16,3,6,16,6,17,7,18,17,7,17,6,7,18,17,7,17,6,10,11,18,10,18,7,10,11,18,10,18,7,8,11,10,8,10,7,8,11,10,8,10,7,9,8,7,9,8,7,9,7,6,9,7,6,6,5,4,6,4,3,14,5,6,12,14,6,12,6,3,6,5,4,6,4,3,14,5,6,12,14,6,12,6,3,4,12,3,4,12,3,5,13,4,13,12,4,5,13,4,13,12,4,15,14,12,15,12,13,15,14,12,15,12,13,14,15,5,14,15,5,5,15,13,5,15,13,20,21,22,29,20,23,23,20,22,20,21,22,29,20,23,23,20,22,22,21,39,22,21,39,36,23,22,39,36,22,36,23,22,39,36,22,37,23,36,37,23,36,26,37,38,37,26,23,26,37,38,37,26,23,23,25,26,26,27,28,26,28,29,26,38,27,29,23,26,26,25,34,23,26,34,23,25,26,26,27,28,26,28,29,26,38,27,29,23,26,26,25,34,23,26,34,27,38,30,27,30,28,27,38,30,27,30,28,38,31,30,38,31,30,30,31,28,30,31,28,33,32,34,33,34,35,23,34,32,25,35,34,33,32,34,33,34,35,23,34,32,25,35,34,24,33,35,24,32,33,24,33,35,24,32,33,23,32,24,23,32,24,23,24,25,23,24,25,24,35,25,24,35,25];class Pt extends st{action(){const e=[];u(e,this.from,this.to,this.current_step),this.object[this.property]=e}pre_start(){super.pre_start(),this.from=this.object[this.property].slice()}}const It=new AudioContext,Nt=[220,246.942,261.626,293.665,329.628,349.228,415.305,440],wt=It.createBiquadFilter();wt.type="lowpass",wt.frequency.value=100,wt.Q.value=10;const Ot=It.createConvolver();Ot.buffer=$(10,10),wt.connect(Ot),Ot.connect(It.destination);const Bt={ifrq:0.0204082,atk:0.367347,dcy:0.183673,fmod1:0.0612245,atkf1:0,dcyf1:1,fmod2:0.285714,atkf2:0.22449,dcyf2:0.489796,amod1:0.367347,atka1:0.387755,dcya1:0.734694,amod2:0.204082,atka2:0.428571,dcya2:0.142857},Dt=4,Ct=[[0,1,0.0432336,0,2.66717,-0.0897549,-0.311383,2.19602,0.234146,-0.63757,1.36243,0.125756,-2.39534,2.44478,-0.378434,-1.73172,-1.46682,-0.378434,-0.891271,-1.67049,0.125756,-2.88463,-2.81215,0.125755,0,-3.5,0.108391,0,-1.67049,-0.39161,-1.59801,-4.78739,0.125755,0,-5.27165,0.234146,-2.39534,2.44478,-0.126923,-3.45125,2.35058,-3.40775,-1.73172,-1.46682,-0.126923,-3.10363,0.637105,-3.60768,0,1,0.40839,0,-1.67049,0.464128,0,-2.87961,0.359902,0,2.16981,0.60839,0,1,0.0432336,0,2.66717,-0.0897549,0.311383,2.19602,0.234146,0.63757,1.36243,0.125756,2.39534,2.44478,-0.378434,1.73172,-1.46682,-0.378434,0.891271,-1.67049,0.125756,2.88463,-2.81215,0.125755,0,-3.5,0.108391,0,-1.67049,-0.39161,1.59801,-4.78739,0.125755,0,-5.27165,0.234146,2.39534,2.44478,-0.126923,3.45125,2.35058,-3.40775,1.73172,-1.46682,-0.126923,3.10363,0.637105,-3.60768,0,1,0.40839,0,-1.67049,0.464128,0,-2.87961,0.359902,0,2.16981,0.60839],[0,1,-0.18593,0,2.66717,-0.318919,-0.311383,2.19602,0.00498234,-0.63757,1.36243,0.125756,-2.13574,2.71753,0.924384,-1.27253,-1.44252,0.497551,-0.891271,-1.67049,0.125756,-2.88463,-2.81215,0.125755,0,-3.5,-0.120773,0,-1.67049,-0.620773,-1.59801,-4.78739,0.125755,0,-5.27165,0.00498211,-2.13066,2.69291,1.17464,-5.74559,1.12196,4.29641,-1.26745,-1.46715,0.747802,-5.69843,-0.612202,4.29641,0,1,0.179227,0,-1.67049,0.234964,0,-2.87961,0.130738,0,2.16981,0.379227,0,1,-0.18593,0,2.66717,-0.318919,0.311383,2.19602,0.00498234,0.63757,1.36243,0.125756,2.13574,2.71753,0.924384,1.27253,-1.44252,0.497551,0.891271,-1.67049,0.125756,2.88463,-2.81215,0.125755,0,-3.5,-0.120773,0,-1.67049,-0.620773,1.59801,-4.78739,0.125755,0,-5.27165,0.00498211,2.13066,2.69291,1.17464,5.74559,1.12196,4.29641,1.26745,-1.46715,0.747802,5.69843,-0.612202,4.29641,0,1,0.179227,0,-1.67049,0.234964,0,-2.87961,0.130738,0,2.16981,0.379227]].map((e)=>({vertices:e,indices:Ft})),Vt=1e3,Ut=0.7,qt=0.6,Mt=1.74,Yt=25,Ht=25;let jt=[],Gt=[];const Wt=5e3;let Kt,Xt={};const Qt={level:null,hue:0,target:null,results:[],idle_reason:null},Jt=function(...e){return function(t,n,r){return e.reduce((e,t)=>t(e,n,r),t)}}(function(e=Se,t,r){switch(t){case"T0":{const[t,...a]=r;return setTimeout(window.dispatch,1e3,t,...a),setTimeout(window.dispatch,2e3,"T1"),n(e,{next_scene:t})}case"T1":return n(e,{next_scene:null});case Le.INIT:return setTimeout(window.dispatch,1e3,"T1"),e;case Te.INTRO:case Te.FIND:case Te.PLAY:case Te.SCORE:case Te.LEVELS:case Te.NOPASS:{const{next_scene:t}=e;return n(e,{current_scene:t})}default:return e;}},function(e=Qt,t,r){function a(){window.dispatch(Le.VALIDATE_SNAPSHOT),window.goto(Te.SCORE)}switch(t){case Le.INIT:{te();const t=localStorage.getItem("results"),r=t?t.split(" ").map((e)=>parseInt(e)):[];return n(e,{results:r})}case Te.FIND:{const[t]=r,[a,o]=me(t+1);return n(e,{index:t,level:a,hue:o})}case Le.SAVE_SNAPSHOT:{const[t]=r;return n(e,{target:t})}case Le.LOCK_POINTER:{const{level:t}=e;return t.canvas.requestPointerLock(),e}case Te.PLAY:{const{level:t,hue:r,target:o}=e;return de(t,r,o),t.canvas.addEventListener("click",a),ue(),n(e,{idle_reason:null})}case Le.WARN_IDLE:{const[t]=r;return n(e,{idle_reason:t})}case Le.VALIDATE_SNAPSHOT:{const{level:t,index:r,target:o,results:i}=e,s=_e(t,o),c=[...i.slice(0,r),s,...i.slice(r+1)];return pe(),t.canvas.removeEventListener("click",a),document.exitPointerLock(),localStorage.setItem("results",c.join(" ")),n(e,{results:c})}case Te.LEVELS:return n(e,{level:null});default:return Object.assign({},Qt,e);}}),{attach:zt,connect:Zt,dispatch:$t}=function(e){function t(){for(const[e,t]of r){const r=t();if(r!==a.get(e)){a.set(e,r),e.innerHTML=r;const t=new CustomEvent("render",{detail:n});e.dispatchEvent(t)}}}let n=e();const r=new Map,a=new Map;return{attach(e,n){r.set(n,e),t()},connect(e){return(...t)=>e(n,...t)},dispatch(r,...a){n=e(n,r,a),t()}}}(Jt);window.dispatch=$t,window.goto=(...e)=>$t("T0",...e),$t(Le.INIT);var en=Zt(function({next_scene:t},{id:n,from:r,to:a,flash:o=!1},...i){return e`
    ${i}
    ${null===t?null:t===n?`<div class="ui fadeout ${r}"></div>`:`<div class="ui ${o?"flash":"fadein"} ${a}"></div>`}`}),tn=Zt(function({results:t}){const n=t.length?`goto(${Te.LEVELS})`:`goto(${Te.FIND}, 0)`;return en({id:Te.INTRO,from:"black",to:"black"},e`
      <div class="ui action" onclick="${n}">
        <div class="pad" style="font-style: italic;">
          All those moments will be lost in time, like tears in rain.
        </div>
        <div class="pad">
          Collect your memories before they fade away.
        </div>
      </div>`)}),nn=Zt(function({next_scene:t,hue:n}){const r=t===Te.PLAY?null:`background: hsl(${360*n}, 70%, 60%); `+"animation: fadein 1s 1s forwards reverse";return en({id:Te.FIND,from:"black",to:"white"},e`
      <div class="ui" style="${r}"></div>
      <div class="ui action"
        onclick="dispatch(${Le.LOCK_POINTER}); goto(${Te.PLAY})">
        <div class="pad">Find this moment.</div>
      </div>`)}),rn=Zt(function({idle_reason:t}){const n="keydown"===t?"Walk with the WASD keys.":"Move the mouse.";return en({id:Te.PLAY,from:"white",to:"white",flash:!0},e`<div class="ui"
      onclick="dispatch(${Le.VALIDATE_SNAPSHOT}); goto(${Te.SCORE})">
        ${t&&`<div style="opacity: 0; animation: fadein 2s 1s alternate 2;">${n}</div>`}</div>`)}),an=Zt(function({results:t,index:n,target:r}){const a=t[n],o=15>a?"Doesn't look like it.":35>a?"It was something else.":50>a?"It's not quite the same.":75>a?"Could it be?":85>a?"It reminds you of something.":95>a?"That's it, almost there.":"Wonderful. You've found it.";return en({id:Te.SCORE,from:"white",to:"black"},e`
      <img class="ui"
        style="opacity: .5"
        src="${r.snapshot}">
      <div class="ui action"
        onclick="goto(${Te.LEVELS})">
        <div class="pad" style="margin: 1.5rem 0 1rem;">${o}</div>
        <div>${t[n]}</div>
      </div>`)}),on=Zt(function({results:t}){const n=t.reduce((e,t)=>e+t,0),r=Ee(n/t.length),a=100*(1-2.5/t.length);return en({id:Te.LEVELS,from:"black",to:"black"},e`
      <div class="ui black">
        <div class="pad">
          ${t.map(ge)}
          ${r>a?`<div class="action" style="padding: .5rem;"
                onclick="goto(${Te.FIND}, ${t.length})">next</div>`:`<div class="action" style="padding: .5rem;"
                onclick="goto(${Te.NOPASS})"
                title="Collect more accurate moments before advancing.">…?</div>`}
        </div>
      </div>`)});const sn=[function(){return en({id:Te.TITLE,from:"black",to:"black"},e`
      <div class="ui action"
        onclick="goto(${Te.INTRO})">
        <div class="pad" style="margin: 1.3rem 0 1rem;">A moment lost in time.</div>
        <div style="font-size: 0.3rem; animation: fadein 1s 3s both">
          A story by <a href="https://piesku.com">piesku.com</a>.</div>
      </div>`)},tn,nn,rn,an,on,function(){return en({id:Te.NOPASS,from:"black",to:"black"},e`
      <div class="ui action black"
        onclick="goto(${Te.LEVELS})">
        <div class="pad">
          The path onward is never easy.
          Collect more accurate moments before venturing forth.
        </div>
      </div>`)}];var cn=Zt(function({current_scene:e}){const t=sn[e];return t?t():""});zt(cn,document.querySelector("#root"))})();
